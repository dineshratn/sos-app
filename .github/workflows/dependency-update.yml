name: Dependency Updates

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  update-node-dependencies:
    name: Update Node.js Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - auth-service
          - user-service
          - medical-service
          - notification-service
          - communication-service
          - api-gateway

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Update dependencies
        working-directory: sos-app/services/${{ matrix.service }}
        run: |
          npm update
          npm audit fix || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(${{ matrix.service }}): update dependencies"
          title: "chore(${{ matrix.service }}): update dependencies"
          body: |
            Automated dependency update for ${{ matrix.service }}

            - Updated npm dependencies
            - Fixed known security vulnerabilities
          branch: dependency-updates/${{ matrix.service }}
          delete-branch: true

  update-go-dependencies:
    name: Update Go Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - emergency-service
          - location-service
          - device-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Update dependencies
        working-directory: sos-app/services/${{ matrix.service }}
        run: |
          go get -u ./...
          go mod tidy

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(${{ matrix.service }}): update Go dependencies"
          title: "chore(${{ matrix.service }}): update Go dependencies"
          body: |
            Automated dependency update for ${{ matrix.service }}

            - Updated Go modules
            - Tidied go.mod and go.sum
          branch: dependency-updates/${{ matrix.service }}
          delete-branch: true

  update-python-dependencies:
    name: Update Python Dependencies
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - llm-service

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Update dependencies
        working-directory: sos-app/services/${{ matrix.service }}
        run: |
          python -m pip install --upgrade pip
          pip install pip-tools
          pip-compile --upgrade requirements.in || pip install --upgrade -r requirements.txt

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore(${{ matrix.service }}): update Python dependencies"
          title: "chore(${{ matrix.service }}): update Python dependencies"
          body: |
            Automated dependency update for ${{ matrix.service }}

            - Updated Python packages
            - Refreshed requirements.txt
          branch: dependency-updates/${{ matrix.service }}
          delete-branch: true
